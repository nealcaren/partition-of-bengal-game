<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Divide and Rule: The Bengal Partition Crisis of 1905</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<header>
  <div class="header-row">
    <h1>Divide and Rule: The Bengal Partition Crisis of 1905</h1>
    <span id="versionBadge" class="version-badge"></span>
  </div>
</header>
<main>
  <div class="panel vignette-panel" id="vignettePanel">
    <div class="vignette-header">
      <h2 id="vignetteTitle">Loading briefing…</h2>
    </div>
    <div id="vignetteText" class="vignette-text"></div>
    <button id="vignetteNext" class="cta-button" type="button">Continue</button>
  </div>

  <div class="panel hidden" id="statsPanel">
    <div id="stats" class="stats"></div>
  </div>

  <div class="panel hidden" id="gamePanel">
    <div id="narration" class="narration"></div>
    <div id="options" class="options"></div>
    <div id="statusMessage" class="status"></div>
    <div class="inputbar">
      <input id="userInput" type="text" placeholder="Type your decision (or click an option)…"/>
      <button class="send" id="sendBtn">Send</button>
    </div>
    <button class="secondary hidden" id="restartBtn" type="button">Start New Game</button>
    <div class="footer">Tip: you can type a custom policy (e.g., “Convene moderate leaders and promise a review in 6 months”).</div>
  </div>
  <div id="waitingOverlay" class="waiting-overlay hidden" role="status" aria-live="assertive">
    <div class="waiting-dialog">
      <div class="waiting-header">Dispatch Pending</div>
      <p>The telegraph clerks labour furiously; a reply from Calcutta is en route…</p>
    </div>
  </div>
</main>

<script>
const GAME_VERSION = 'v1.2.0';

const FALLBACK_VIGNETTE_PAGES = [
  {
    title: "August 1905 — Simla",
    text: `The monsoon clouds hang heavy over the Viceregal Lodge. You've served as private secretary to Lord Curzon for eighteen months now, long enough to read the particular tension in his jawline as he slides a leather portfolio across the mahogany desk.

"The Partition will be announced within weeks," he says. "Bengal is unwieldy—78 million souls, impossible to govern effectively. We're creating two provinces: a Muslim-majority east with its capital at Dacca, and a Hindu-majority west centered on Calcutta."

On paper, it's administrative reform. The files cite population density, revenue collection challenges, the difficulty of managing such vast territory.

But you've read the intelligence reports. You know what the Bengali press is saying.`,
    button: "Continue"
  },
  {
    title: "The Calcutta Papers",
    text: `Three newspapers sit before you, each telling a different story:

**The Englishman** (British-owned): "Lord Curzon's masterstroke will bring efficient governance to India's most populous province."

**Amrita Bazar Patrika** (Bengali nationalist): "The Partition is a dagger aimed at Bengali unity—splitting Hindu from Muslim, severing our cultural heartland."

**The Bengalee** (edited by Surendranath Banerjee): "Partition invites profound disappointment, yet our response must remain constitutional—petitions, not bombs."

But there are newer voices too. Younger men—Bipin Chandra Pal, Aurobindo Ghose—speak of *swadeshi* (own-country), of boycotting British goods entirely. Of meeting foreign rule not with petitions, but with resistance.

The question everyone whispers: Is this really about administration? Or is it "divide and rule"?`,
    button: "Continue"
  },
  {
    title: "Your Task",
    text: `Lord Curzon leans back. "The decision is made. London supports it. But implementation—that's where empires are won or lost."

He needs you to manage what comes next. The official announcement. The inevitable protests. The competing factions within the Indian political class—moderates who still believe in petitions and constitutional reform, and extremists who speak openly of driving the British from India.

"You'll have broad discretion," Curzon continues. "Suppress sedition, certainly. But also—consider concessions where prudent. Industrial grants, educational reforms, consultation with loyal elements. We must maintain order without igniting rebellion."

He pauses at the door. "The Partition is administrative necessity. But Bengal is... passionate. Literate. They produce poets and revolutionaries in equal measure. Don't let it become a spark."

The leather folder contains your initial briefing papers. The choices you make in the coming months will shape whether this reform strengthens British India—or begins its unraveling.`,
    button: "Continue"
  },
  {
    title: "Your Goals",
    text: `As the Viceroy's private secretary, you must navigate the crisis of the Bengal Partition. Your decisions will be measured across four key pressures:

**Legitimacy** — Does the British administration maintain credibility with Indian elites and the wider public?

**Local Stability** — Can you prevent the situation from tipping into riots, strikes, or violence?

**Swadeshi Momentum** — The boycott movement is growing. Will you contain it, redirect it, or concede ground?

**Reputation** — In London and Delhi, are you judged a steady hand or a liability to imperial governance?

The game will surface the dilemmas facing colonial administrators: how to project authority without provoking revolt, how to negotiate with moderate nationalists while confronting radicals, and how economic protest became a crucible for Indian self-rule.

History remembers that the Partition was annulled in 1911. Your decisions will show why.`,
    button: "Continue"
  },
  {
    title: "Game Rules",
    text: `Your post lasts only if the Raj believes you can keep Bengal orderly.

You will be **removed from your post** if any of the following happen:
- Legitimacy collapses (value < 20) — your administration loses the confidence of Calcutta and London alike.
- Local Stability collapses (value < 20) — unrest overwhelms your ability to govern.
- Swadeshi Momentum becomes unstoppable (value > 85) — the boycott makes the Partition unworkable.

You will **survive to the end of 1908** if none of those crises occur before the calendar reaches 31 December 1908.

Every turn advances time; every decision shifts the numbers. Choose with care.`,
    button: "Begin Game"
  }
];

const STARTING_SCENARIO = `The breakfast files still sit before you:

**1. Police Commissioner Bamfield's arrest warrants**
Twelve names. Firebrands, agitators, men who speak of bombs and boycotts. Strike now, before they organize—but risk making martyrs.

**2. Surendranath Banerjee's request for audience** 
The moderate voice. Constitutional methods. Petitions and deputations. He wants to channel dissent through proper channels—if you'll listen.

**3. Commerce Department proposal**
₹50,000 in grants to Bengali textile mills. Undercut the *swadeshi* appeal by funding indigenous industry. But will it look like a bribe?

The monsoon clouds are breaking. By afternoon, all Calcutta will know the Partition is confirmed.

What do you do first?`;

const STARTING_OPTIONS = [
  "Authorize Commissioner Bamfield to execute the arrest warrants before the swadeshi meetings swell.",
  "Grant Surendranath Banerjee an immediate audience to channel dissent through petitions.",
  "Approve the ₹50,000 textile grant to blunt the boycott and placate loyal industry leaders.",
  "Dispatch a trusted aide to College Square and Dacca to verify police intelligence."
];

const INITIAL_STATE = {
  date: '1905-08-15',
  legitimacy: 60,
  local_stability: 60,
  swadeshi_momentum: 40,
  reputation: 50,
  version: GAME_VERSION
};

let sessionId = null;
let selectedOptionButton = null;
let selectedOptionText = '';
let vignettePages = [];
let currentVignetteIndex = 0;
let gameReady = false;
let gameOver = false;
const waitingOverlay = document.getElementById('waitingOverlay');
let previousState = null;
const DISPATCH_SCENES = [
[
    "The telegraph clerks labour furiously; a reply from Calcutta is en route…",
    "Cipher officers double-check the codebook, unwilling to risk a misread dispatch…",
    "From the counting house, a runner signals the lines are still clear…",
    "Ink dries on the Viceroy's marginalia; the return message is nearly upon us…"
  ],
  [
    "Messenger pigeons beat the air above Writers' Building, searching for a familiar perch…",
    "The Morse key clatters, pauses, then clatters again—someone is editing the reply midstream…",
    "A clerk rewinds the wax cylinder recorder, anxious not to miss a single pulse…",
    "Bootheels echo in the corridor; an orderly hurries forward with the sealed note…"
  ],
  [
    "On Eden Gardens, officers halt their cricket as the signal flag rises over the telegraph mast…",
    "A draughtsman traces troop dispositions while waiting for confirmation from Fort William…",
    "The Resident's office dimly glows; hurricane lamps are trimmed to welcome the reply…",
    "Stamping wax is warmed—only the Governor-General's counter-signature remains…"
  ],
  [
    "A punkah-wallah fans the cipher room while three officers debate a contested word…",
    "The District Magistrate's runner arrives breathless; his dispatch pouch is unopened still…",
    "Monsoon rain drums the roof of the telegraph office—the line holds, barely…",
    "A junior secretary blots the fair copy, checking twice for transcription errors…"
  ],
  [
    "Hoofbeats on Chowringhee Road—the mounted courier has made good time from Government House…",
    "In the Registry, a clerk thumbs through precedent files while the response is drafted…",
    "The Commissioner's aide-de-camp waits at the door, telegram form in hand…",
    "Sealing wax hisses as it meets the brass stamp; authentication complete…"
  ],
  [
    "A lamp flickers in the Police Commissioner's window—his night shift continues…",
    "The railway telegraph reports all lines north are functioning; the message will arrive…",
    "Steam whistles from the harbor carry across Dalhousie Square—a ship brings dispatches from Bombay…",
    "Your deputy reviews the filing system, ensuring no prior directive contradicts what comes next…"
  ],
  [
    "College Square lies quiet in the pre-dawn hours; intelligence officers take notes from the shadows…",
    "A bearer refills the inkwell at your desk—correspondence must be answered promptly…",
    "The leather portfolio is retrieved from the safe; only certain eyes may read what it contains…",
    "Footsteps ascend the marble staircase; someone carries news from the Secretariat…"
  ],
  [
    "At Howrah Station, the overnight mail train exhales steam—diplomatic bags are unloaded first…",
    "A cartographer updates the wall map with fresh intelligence; borders shift in red ink…",
    "The duty officer signs the logbook, noting the hour of receipt and the seal's condition…",
    "Through the jalousie shutters, you glimpse a runner crossing the courtyard at speed…"
  ],
  [
    "The Viceroy's private secretary compares three draft responses, selecting the least provocative…",
    "In the cantonment, a major pauses his morning drill to read an urgent communiqué…",
    "Clerks in the Finance Department tally the cost of your last decision; figures are being compiled…",
    "A confidential memorandum arrives from London—weeks old, but still relevant to what comes next…"
  ],
  [
    "The Intelligence Bureau's daily summary is typed, retyped, then marked for your eyes only…",
    "A district officer's handwritten report arrives mud-stained; he rode through the night to send it…",
    "The cipher clerk triple-checks the one-time pad; this message cannot be misread…",
    "At the Press Trust, compositors set tomorrow's headlines—they know before the public does…"
  ],
  [
    "A telegram arrives from Simla, flagged 'IMMEDIATE'—the Viceroy has taken note…",
    "The stationmaster at Sealdah signals all clear; no sabotage on the northern line today…",
    "Your morning tea grows cold as you await confirmation from three separate departments…",
    "In the archives, a researcher pulls the 1857 files—precedent for emergency powers, should you need them…"
  ],
  [
    "A despatch rider dismounts in the courtyard, his satchel bearing the Governor's seal…",
    "The Bengali press has gotten wind of something; your press liaison prepares a statement…",
    "From Dacca, a coded message: Nawab Salimullah's response to your last communication…",
    "The clock in the Council Chamber strikes the hour; decisions made now will ripple outward…"
  ]

];
let dispatchTimer = null;
let dispatchIndex = 0;
let dispatchScene = DISPATCH_SCENES[0];

const GLOSSARY_ENTRIES = [
  {
    term: 'Lord Curzon',
    description: 'George Nathaniel Curzon, Viceroy of India (1899–1905), who championed the partition for administrative reasons.'
  },
  {
    term: 'Section 144',
    description: 'A colonial-era regulation allowing local officials to prohibit assemblies and impose curfews when public order is threatened.'
  },
  {
    term: 'Vernacular Press Act',
    description: 'An 1878 law enabling censorship or shutdown of Indian-language newspapers deemed seditious by the Raj.'
  },
  {
    term: 'CID',
    description: 'The Criminal Investigation Department, British India’s intelligence branch charged with monitoring nationalist activity.'
  },
  {
    term: 'Surendranath Banerjee',
    description: 'Moderate Indian National Congress leader who favoured petitions and constitutional protest against the partition.'
  },
  {
    term: 'Bipin Chandra Pal',
    description: 'A leading Swadeshi organiser urging boycott of British goods and advocating more assertive resistance.'
  },
  {
    term: 'Aurobindo Ghose',
    description: 'Nationalist intellectual who left the civil service to champion passive resistance and cultural revival.'
  },
  {
    term: 'Rabindranath Tagore',
    description: 'Bengali poet and Nobel laureate who mobilised cultural opposition to partition, including unity ceremonies like Raksha Bandhan.'
  },
  {
    term: 'swadeshi',
    description: 'From Sanskrit for “of one’s own country”; the boycott movement promoting indigenous industry over imported British goods.'
  },
  {
    term: 'Muslim League',
    description: 'Political organisation founded in 1906 to represent Muslim interests while engaging with imperial authorities.'
  },
  {
    term: 'Indian National Congress',
    description: 'Pan-Indian political forum split in 1905 between moderates seeking petitions and extremists pushing direct action.'
  },
  {
    term: 'Dacca',
    description: 'Planned capital of the new Eastern Bengal and Assam province; today’s Dhaka in Bangladesh.'
  },
  {
    term: 'Calcutta',
    description: 'Seat of the Bengal government and hotbed of anti-partition agitation until the imperial capital shifted to Delhi in 1911.'
  }
].sort((a, b) => b.term.length - a.term.length);

const GLOSSARY_PATTERN = new RegExp(
  `\\b(${GLOSSARY_ENTRIES.map(({ term }) => term.replace(/[-/\\^$*+?.()|[\]{}]/g, '\\$&').replace(/\s+/g, '::SPACE::')).join('|')})\\b`,
  'gi'
);

function setOverlayMessage(text) {
  const paragraph = waitingOverlay ? waitingOverlay.querySelector('p') : null;
  if (paragraph) {
    paragraph.textContent = text;
  }
}

function updateVersionBadge(version) {
  const badge = document.getElementById('versionBadge');
  if (badge) {
    badge.textContent = version || GAME_VERSION;
  }
}

function scrollToTop() {
  const options = { top: 0, behavior: 'smooth' };
  window.scrollTo(options);
  if ('scrollTo' in window && 'visualViewport' in window && window.visualViewport) {
    setTimeout(() => window.scrollTo(options), 200);
    setTimeout(() => window.scrollTo(options), 400);
  }
}

function startDispatchCycle() {
  if (!waitingOverlay) return;
  dispatchScene = DISPATCH_SCENES[Math.floor(Math.random() * DISPATCH_SCENES.length)];
  dispatchIndex = 0;
  setOverlayMessage(dispatchScene[dispatchIndex]);
  stopDispatchCycle();
  dispatchTimer = setInterval(() => {
    dispatchIndex += 1;
    if (dispatchIndex >= dispatchScene.length) {
      dispatchIndex = dispatchScene.length - 1;
    }
    setOverlayMessage(dispatchScene[dispatchIndex]);
  }, 4000);
}

function stopDispatchCycle() {
  if (dispatchTimer) {
    clearInterval(dispatchTimer);
    dispatchTimer = null;
  }
}

function escapeHtml(raw) {
  return (raw || '').replace(/[&<>"']/g, (ch) => {
    switch (ch) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return ch;
    }
  });
}

function escapeAttr(raw) {
  return escapeHtml(raw).replace(/`/g, '&#96;');
}

function wrapBlockquotes(html) {
  return html.replace(/<p>&gt;\s?([\s\S]*?)<\/p>/g, (_match, body) => {
    const cleaned = body.replace(/<br\/>/g, '<br/>');
    return `<blockquote>${cleaned}</blockquote>`;
  });
}

function convertTimelineBlocks(text) {
  return text.replace(/\[Timeline • ([^\]]+)\]\s*([\s\S]*?)(?=(?:\n\n|$))/g, (_match, label, body) => {
    const safeBody = body.trim();
    return `<div class="timeline-event"><div class="timeline-event__label">Timeline • ${label}</div><div class="timeline-event__body">${safeBody}</div></div>`;
  });
}

function applyGlossaryMarkup(html) {
  return html.replace(GLOSSARY_PATTERN, (match) => {
    const normalized = match.toLowerCase().replace(/\s+/g, ' ');
    const entry = GLOSSARY_ENTRIES.find(({ term }) => term.toLowerCase() === normalized);
    if (!entry) return match;
    return `<span class="glossary-term" tabindex="0" data-description="${escapeAttr(entry.description)}">${match}</span>`;
  });
}

function getFallbackVignette() {
  return FALLBACK_VIGNETTE_PAGES.map(page => ({ ...page }));
}

function applyInlineMarkup(block) {
  let escaped = escapeHtml(block)
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/__(.*?)__/g, '<strong>$1</strong>')
    .replace(/\*(?!\*)([^*\n]+)\*/g, '<em>$1</em>')
    .replace(/_(?!_)([^_\n]+)_/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br/>');
  escaped = wrapBlockquotes(escaped);
  return escaped;
}

function formatVignetteText(text) {
  const trimmed = (text || '').trim();
  if (!trimmed) return '';
  const markup = trimmed
    .split(/\n{2,}/)
    .map(paragraph => `<p>${applyInlineMarkup(paragraph)}</p>`)
    .join('');
  return applyGlossaryMarkup(convertTimelineBlocks(markup));
}

async function loadVignette() {
  try {
    const res = await fetch('/api/vignette');
    if (!res.ok) {
      throw new Error('Unable to fetch opening briefing.');
    }
    const data = await res.json();
    if (data && Array.isArray(data.pages) && data.pages.length) {
      vignettePages = data.pages;
      return;
    }
    throw new Error('Opening briefing is empty.');
  } catch (err) {
    console.warn('Falling back to bundled vignette:', err);
    vignettePages = getFallbackVignette();
  }
}

function showVignettePage(index) {
  if (!vignettePages.length) {
    vignettePages = getFallbackVignette();
  }
  currentVignetteIndex = Math.min(Math.max(index, 0), vignettePages.length - 1);
  const page = vignettePages[currentVignetteIndex] || {};
  document.getElementById('vignetteTitle').textContent = page.title || 'Briefing';
  document.getElementById('vignetteText').innerHTML = formatVignetteText(page.text || '');
  const button = document.getElementById('vignetteNext');
  const isLast = currentVignetteIndex === vignettePages.length - 1;
  button.textContent = page.button || (isLast ? 'Begin Game' : 'Continue');
  scrollToTop();
}

function resetInteractiveState() {
  selectedOptionButton = null;
  selectedOptionText = '';
  gameOver = false;
  const optionsBox = document.getElementById('options');
  if (optionsBox) {
    optionsBox.innerHTML = '';
  }
  const statusEl = document.getElementById('statusMessage');
  if (statusEl) {
    statusEl.textContent = '';
    statusEl.classList.remove('status-victory', 'status-defeat');
  }
  const input = document.getElementById('userInput');
  if (input) {
    input.value = '';
    input.disabled = false;
  }
  const sendBtn = document.getElementById('sendBtn');
  if (sendBtn) {
    sendBtn.disabled = false;
  }
  const restartBtn = document.getElementById('restartBtn');
  if (restartBtn) {
    restartBtn.classList.add('hidden');
  }
  const narration = document.getElementById('narration');
  if (narration) {
    narration.textContent = '';
  }
  previousState = null;
}

async function beginGameFlow() {
  resetInteractiveState();
  gameReady = false;
  document.getElementById('vignettePanel').classList.add('hidden');
  document.getElementById('statsPanel').classList.remove('hidden');
  document.getElementById('gamePanel').classList.remove('hidden');
  renderStats(INITIAL_STATE);
  showStartingScenario();
  const sendBtn = document.getElementById('sendBtn');
  const input = document.getElementById('userInput');
  sendBtn.disabled = true;
  input.disabled = true;
  try {
    await createSession();
    gameReady = true;
    sendBtn.disabled = false;
    input.disabled = false;
  } catch (err) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.textContent = 'The telegraph office reports a disruption: ' + err.message;
    sendBtn.disabled = false;
    input.disabled = false;
  }
}

async function createSession() {
  const res = await fetch('/api/new');
  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || 'Unable to open a new briefing docket.');
  }
  const data = await res.json();
  sessionId = data.session_id;
}

function showStartingScenario() {
  const narrationEl = document.getElementById('narration');
  narrationEl.innerHTML = formatVignetteText(STARTING_SCENARIO);
  populateOptions(STARTING_OPTIONS);
  updateVersionBadge(INITIAL_STATE.version || GAME_VERSION);
  scrollToTop();
}

function renderStats(state) {
  const statsGrid = document.getElementById('stats');
  if (!statsGrid || !state) {
    return;
  }
  const metrics = [
    { label: 'Legitimacy', key: 'legitimacy', value: state.legitimacy },
    { label: 'Local Stability', key: 'local_stability', value: state.local_stability },
    { label: 'Swadeshi Momentum', key: 'swadeshi_momentum', value: state.swadeshi_momentum },
    { label: 'Reputation', key: 'reputation', value: state.reputation }
  ];

  const cards = metrics.map(({ label, key, value }) => {
    const statClass = getStatClass(key, value);
    const numeric = Number.isFinite(Number(value)) ? Number(value) : null;
    const descriptor = getStatDescriptor(key, value);
    const tooltip = numeric !== null ? `title="Exact value: ${numeric}"` : '';
    const trendMarkup = getTrendMarkup(key, value);
    return `
      <div class="stat ${statClass}">
        <span class="stat-label">${label}</span>
        <span class="stat-value" ${tooltip}>${descriptor}${trendMarkup}</span>
        <span class="stat-numeric">${numeric !== null ? numeric : '—'}</span>
      </div>
    `;
  }).join('');

  statsGrid.innerHTML = `
    <div class="stat stat-date">
      <span class="stat-label">Date</span>
      <span class="stat-value">${state.date ?? '—'}</span>
    </div>
    ${cards}
  `;
  previousState = {
    legitimacy: state.legitimacy,
    local_stability: state.local_stability,
    swadeshi_momentum: state.swadeshi_momentum,
    reputation: state.reputation
  };
}

function getStatClass(key, rawValue) {
  const value = Number(rawValue);
  if (Number.isNaN(value)) {
    return 'stat-neutral';
  }
  if (key === 'swadeshi_momentum') {
    if (value > 80) return 'stat-critical';
    if (value > 70) return 'stat-warning';
    if (value <= 40) return 'stat-good';
  } else if (key === 'legitimacy' || key === 'local_stability' || key === 'reputation') {
    if (value < 25) return 'stat-critical';
    if (value < 35) return 'stat-warning';
    if (value >= 70) return 'stat-good';
  }
  return 'stat-neutral';
}

function getTrendMarkup(key, currentValue) {
  if (!previousState) {
    return '';
  }
  const previousValue = Number(previousState[key]);
  const currentNumber = Number(currentValue);
  if (Number.isNaN(previousValue) || Number.isNaN(currentNumber)) {
    return '';
  }
  if (previousValue === currentNumber) {
    return '';
  }
  const increased = currentNumber > previousValue;
  const beneficial = isIncreaseBeneficial(key, increased);
  const icon = increased ? '▲' : '▼';
  const trendClass = increased ? (beneficial ? 'trend-up-good' : 'trend-up-bad') : (beneficial ? 'trend-down-good' : 'trend-down-bad');
  return `<span class="trend-icon ${trendClass}" aria-hidden="true">${icon}</span>`;
}

function isIncreaseBeneficial(key, increased) {
  // Returns true if the resulting change is beneficial.
  if (key === 'swadeshi_momentum') {
    return !increased;
  }
  return increased;
}

function getStatDescriptor(key, rawValue) {
  const value = Number(rawValue);
  if (Number.isNaN(value)) {
    return 'Unknown';
  }
  if (key === 'swadeshi_momentum') {
    if (value <= 30) return 'Dormant';
    if (value <= 50) return 'Flickering';
    if (value <= 70) return 'Surging';
    if (value <= 85) return 'Blazing';
    return 'Unstoppable';
  }
  if (value >= 80) return 'Commanding';
  if (value >= 60) return 'Steady';
  if (value >= 40) return 'Wavering';
  if (value >= 25) return 'Precarious';
  return 'Collapsed';
}

function renderTurn(data) {
  if (!data) return;
  const narrationEl = document.getElementById('narration');
  narrationEl.innerHTML = formatVignetteText(data.narration || '');
  if (data.state) {
    renderStats(data.state);
    updateVersionBadge(data.state.version || GAME_VERSION);
  }
  populateOptions(data.options || []);
  document.getElementById('userInput').value = '';
  scrollToTop();
}

function populateOptions(options) {
  const optBox = document.getElementById('options');
  optBox.innerHTML = '';
  selectedOptionButton = null;
  selectedOptionText = '';
  (options || []).forEach(txt => {
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'option';
    b.textContent = txt;
    b.onclick = () => selectOption(b, txt);
    optBox.appendChild(b);
  });
}

function selectOption(button, text) {
  const optionButtons = document.querySelectorAll('#options button.option');
  optionButtons.forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
  selectedOptionButton = button;
  selectedOptionText = text;
  const input = document.getElementById('userInput');
  input.value = text;
}

function setWaiting(isWaiting, message = '') {
  const statusEl = document.getElementById('statusMessage');
  const sendBtn = document.getElementById('sendBtn');
  const input = document.getElementById('userInput');
  const optionButtons = document.querySelectorAll('#options button.option');

  if (isWaiting) {
    statusEl.classList.remove('status-victory', 'status-defeat');
    statusEl.textContent = '';
    if (message) {
      setOverlayMessage(message);
    } else {
      startDispatchCycle();
    }
    if (waitingOverlay) {
      waitingOverlay.classList.remove('hidden');
    }
    sendBtn.disabled = true;
    input.disabled = true;
    optionButtons.forEach(btn => {
      btn.disabled = true;
      if (btn === selectedOptionButton) {
        btn.classList.add('selected');
      }
    });
  } else {
    if (waitingOverlay) {
      waitingOverlay.classList.add('hidden');
    }
    stopDispatchCycle();
    if (!gameOver || message) {
      statusEl.textContent = message;
    }
    if (!gameOver) {
      statusEl.classList.remove('status-victory', 'status-defeat');
      sendBtn.disabled = false;
      input.disabled = false;
      optionButtons.forEach(btn => {
        btn.disabled = false;
      });
    }
  }
}

async function sendTurn(user_input, options = {}) {
  if (!gameReady || !sessionId || gameOver) {
    return false;
  }
  const { showWaiting = true } = options;
  const payload = { session_id: sessionId, user_input };
  if (showWaiting) {
    setWaiting(true);
  }
  let success = false;
  let followupMessage = '';
  try {
    const res = await fetch('/api/turn', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error(t || 'Request failed');
    }
    const data = await res.json();
    renderTurn(data);
    handleGameConclusion(data.game_status);
    success = true;
  } catch (err) {
    alert('Error: ' + err.message);
    followupMessage = 'The telegraph line falters; no reply was secured: ' + err.message;
  }
  if (showWaiting) {
    setWaiting(false, followupMessage);
  } else if (followupMessage) {
    setWaiting(false, followupMessage);
  }
  return success;
}

function handleGameConclusion(gameStatus) {
  if (!gameStatus || gameStatus.status === 'ongoing') {
    return;
  }
  gameOver = true;
  const statusEl = document.getElementById('statusMessage');
  statusEl.classList.remove('status-victory', 'status-defeat');
  const prefix = gameStatus.status === 'victory' ? 'Victory — ' : 'Defeat — ';
  statusEl.textContent = prefix + (gameStatus.message || '');
  statusEl.classList.add(gameStatus.status === 'victory' ? 'status-victory' : 'status-defeat');

  const sendBtn = document.getElementById('sendBtn');
  const input = document.getElementById('userInput');
  sendBtn.disabled = true;
  input.disabled = true;
  document.querySelectorAll('#options button.option').forEach(btn => {
    btn.disabled = true;
  });
  document.getElementById('restartBtn').classList.remove('hidden');
}

function advanceVignette() {
  if (currentVignetteIndex < vignettePages.length - 1) {
    showVignettePage(currentVignetteIndex + 1);
  } else {
    beginGameFlow();
  }
}

function restartGame() {
  resetInteractiveState();
  sessionId = null;
  gameReady = false;
  document.getElementById('gamePanel').classList.add('hidden');
  document.getElementById('statsPanel').classList.add('hidden');
  document.getElementById('vignettePanel').classList.remove('hidden');
  currentVignetteIndex = 0;
  showVignettePage(0);
}

document.getElementById('vignetteNext').addEventListener('click', advanceVignette);

document.getElementById('sendBtn').addEventListener('click', async () => {
  const inputEl = document.getElementById('userInput');
  const originalText = inputEl.value;
  const text = originalText.trim();
  const optionText = selectedOptionText.trim();
  const inputToSend = text || optionText;
  if (!inputToSend) return;
  const wasSuccessful = await sendTurn(inputToSend);
  if (wasSuccessful) {
    inputEl.value = '';
  } else {
    inputEl.value = originalText;
  }
});

document.getElementById('userInput').addEventListener('input', (event) => {
  if (!selectedOptionButton) return;
  if (event.target.value.trim() !== selectedOptionText.trim()) {
    selectedOptionButton.classList.remove('selected');
    selectedOptionButton = null;
    selectedOptionText = '';
  }
});

document.getElementById('restartBtn').addEventListener('click', restartGame);

(async function init() {
  updateVersionBadge(GAME_VERSION);
  await loadVignette();
  if (!vignettePages.length) {
    vignettePages = getFallbackVignette();
  }
  showVignettePage(0);
})();
</script>
</body>
</html>
